# 納税金額シミュレーター テスト仕様書

## 1. テスト方針

### 1.1 テスト目的

本テスト仕様書は、納税金額シミュレーターの品質を保証するため、以下の観点からテストを実施することを目的とします：

- **機能の正確性**: 税額計算が正確に実行されること
- **入力検証の妥当性**: 不正な入力が適切に検出されること
- **データ整合性**: 保存・読み込みが正しく動作すること
- **ユーザビリティ**: UI操作が直感的でエラーが発生しないこと

### 1.2 テスト範囲

#### 対象範囲
- 計算エンジン（`engine.ts`）
- バリデーション（`validation.ts`）
- データ保存（`storage.ts`）
- UI操作（`App.tsx`）
- ルール読み込み（`rules/index.ts`）
- ユーティリティ（`format.ts`）

#### 対象外
- ブラウザの互換性テスト（別途実施）
- パフォーマンステスト（別途実施）
- セキュリティテスト（別途実施）

### 1.3 テストレベル

1. **単体テスト（Unit Test）**: 各関数・モジュールの個別テスト
2. **結合テスト（Integration Test）**: モジュール間の連携テスト
3. **システムテスト（System Test）**: エンドツーエンドの動作テスト

### 1.4 テスト環境

- **テストフレームワーク**: Vitest
- **実行環境**: Node.js
- **ブラウザテスト**: Playwright（将来実装）
- **カバレッジツール**: Vitest カバレッジ機能

## 2. 単体テスト仕様

### 2.1 計算エンジン（`engine.ts`）

#### 2.1.1 給与所得計算

**テストケース TC-ENGINE-001**: 給与収入から給与所得控除を計算
- **前提条件**: 2024年度ルール、給与収入500万円
- **入力**: `salaryGross = 5,000,000`
- **期待結果**: 給与所得控除 = 1,440,000円（2024年度ルールに基づく）
- **検証項目**: `calcSalaryDeduction`関数の戻り値

**テストケース TC-ENGINE-002**: 給与所得控除の最低保障
- **前提条件**: 2024年度ルール、給与収入100万円
- **入力**: `salaryGross = 1,000,000`
- **期待結果**: 給与所得控除 = 550,000円（最低保障額）
- **検証項目**: 最低保障額が適用されること

**テストケース TC-ENGINE-003**: 給与所得の計算（収入 - 控除）
- **前提条件**: 給与収入500万円、給与所得控除144万円
- **入力**: `salaryGross = 5,000,000`, `salaryDeduction = 1,440,000`
- **期待結果**: 給与所得 = 3,560,000円
- **検証項目**: `salaryIncome = max(0, salaryGross - salaryDeduction)`

**テストケース TC-ENGINE-004**: 複数支払先の給与収入合計
- **前提条件**: 支払先A: 400万円、支払先B: 120万円
- **入力**: `sources = [{annual: 4,000,000}, {annual: 1,200,000}]`
- **期待結果**: 給与収入合計 = 5,200,000円
- **検証項目**: すべての支払先の年額を合計

#### 2.1.2 事業所得計算

**テストケース TC-ENGINE-005**: 事業所得の計算（売上 - 経費）
- **前提条件**: 売上500万円、経費120万円
- **入力**: `sales = 5,000,000`, `expenses = 1,200,000`
- **期待結果**: 事業所得（控除前） = 3,800,000円
- **検証項目**: `businessRaw = sales - expenses`

**テストケース TC-ENGINE-006**: 青色申告控除（電子帳簿）
- **前提条件**: 2024年度ルール、青色申告（電子帳簿）
- **入力**: `blueReturn.enabled = true`, `blueReturn.mode = 'electronic'`
- **期待結果**: 青色申告控除 = 650,000円（2024年度ルール）
- **検証項目**: ルールから正しい控除額を取得

**テストケース TC-ENGINE-007**: 青色申告控除（帳簿方式）
- **前提条件**: 2024年度ルール、青色申告（帳簿方式）
- **入力**: `blueReturn.enabled = true`, `blueReturn.mode = 'book'`
- **期待結果**: 青色申告控除 = 550,000円（2024年度ルール）
- **検証項目**: ルールから正しい控除額を取得

**テストケース TC-ENGINE-008**: 事業所得の最終計算
- **前提条件**: 事業所得（控除前）380万円、青色控除65万円
- **入力**: `businessRaw = 3,800,000`, `blueDed = 650,000`
- **期待結果**: 事業所得 = 3,150,000円
- **検証項目**: `businessIncome = businessRaw - blueDed`

#### 2.1.3 株式収入計算

**テストケース TC-ENGINE-009**: 株式収入の総合/分離分割
- **前提条件**: 配当8万円（総合）、売買益20万円（分離）
- **入力**: `dividend.amount = 80,000`, `dividend.taxMode = 'general'`, `capitalGain.amount = 200,000`, `capitalGain.taxMode = 'separate'`
- **期待結果**: 総合課税 = 80,000円、分離課税 = 200,000円
- **検証項目**: 課税方式に応じて正しく分割

**テストケース TC-ENGINE-010**: 総所得（総合課税）の計算
- **前提条件**: 給与所得356万円、事業所得315万円、株式（総合）8万円
- **入力**: `salaryIncome = 3,560,000`, `businessIncome = 3,150,000`, `stockGeneralIncome = 80,000`
- **期待結果**: 総所得（総合） = 6,790,000円
- **検証項目**: すべての総合課税所得を合計

#### 2.1.4 保険料計算

**テストケース TC-ENGINE-011**: 社保推計計算（社保のみは収入欄の主たる給与を使用）
- **前提条件**: 給与支払先A=400万円、主たる給与=A、推計係数0.15（デフォルト値）
- **入力**: `salary.sources=[{id:'A', annual:4,000,000}]`, `salary.mainSourceId='A'`, `insurance.mode='employeeOnly'`, `insurance.employee.inputMode='estimate'`
- **期待結果**: 社保年額 = 600,000円
- **検証項目**: `annual = Math.round(baseAnnual * rate)` の `baseAnnual` が `salary.mainSourceId` の年額になること

**テストケース TC-ENGINE-012**: 国保推計計算（世田谷標準：基礎/支援/介護の内訳）
- **前提条件**: 前年総所得500万円、加入者数3人、40〜64歳人数1人、加入月数12ヶ月
- **入力**: `prevIncome = 5,000,000`, `membersIncludingTaxpayer=3`, `members4064=1`, `months=12`
- **期待結果**:
  - 基礎（医療）分 = `min(5,000,000×7.71% + 47,300×3, 660,000)`  
  - 支援金分 = `min(5,000,000×2.69% + 16,800×3, 260,000)`  
  - 介護分 = `min(5,000,000×2.25% + 16,600×1, 170,000)`  
  - 合計 = 上記3区分の合算（円単位四捨五入）
- **検証項目**: `estimateNhiAnnual` の内訳（base/support/care）と上限適用、均等割の人数適用、丸めが一致すること

**テストケース TC-ENGINE-013**: 按分計算（年額×月数/12、四捨五入）
- **前提条件**: 年額60万円、月数6ヶ月
- **入力**: `annual = 600,000`, `months = 6`
- **期待結果**: 按分額 = 300,000円（600,000 × 6 / 12 = 300,000）
- **検証項目**: `prorateRound(annual, months) = Math.round((annual * months) / 12)`

**テストケース TC-ENGINE-014**: 複合モードの保険料計算
- **前提条件**: 社保ブロック6ヶ月（推計60万円）、国保ブロック6ヶ月（推計51.5万円）
- **入力**: 複合ブロック構成
- **期待結果**: 社保合計 = 300,000円、国保合計 = 257,500円
- **検証項目**: 各ブロックの按分額を合計

**テストケース TC-ENGINE-015**: 国民年金の計算（加入/免除）
- **前提条件**: 月額16,980円、加入月数5、免除月数1
- **入力**: `monthly = 16,980`, `payMonths = 5`, `exemptMonths = 1`
- **期待結果**: 国年合計 = 84,900円（16,980 × 5）
- **検証項目**: 免除月数は0円として計算

#### 2.1.5 控除計算

**テストケース TC-ENGINE-016**: 基礎控除の段階制
- **前提条件**: 2024年度ルール、総所得2,400万円
- **入力**: `totalIncomeGeneral = 24,000,000`
- **期待結果**: 基礎控除 = 480,000円
- **検証項目**: `pickBracketValue`関数で正しい段階を選択

**テストケース TC-ENGINE-017**: 基礎控除の段階縮小（高所得者）
- **前提条件**: 2024年度ルール、総所得2,500万円
- **入力**: `totalIncomeGeneral = 25,000,000`
- **期待結果**: 基礎控除 = 0円
- **検証項目**: 高所得者で控除が0になること

**テストケース TC-ENGINE-018**: 生命保険料控除（一般・所得税）
- **前提条件**: 一般生命保険料8万円
- **入力**: `paid = 80,000`
- **期待結果**: 控除額 = 40,000円（8万超は一律4万円）
- **検証項目**: 所得税用の計算式（2万/4万/8万の閾値）に従うこと

**テストケース TC-ENGINE-019**: 生命保険料控除（住民税・上限7万円）
- **前提条件**: 住民税用の合計上限は7万円
- **入力**: 一般/介護医療/個人年金の支払保険料がそれぞれ上限を超えるケース
- **期待結果**: 住民税用生命保険料控除（合計） = 70,000円
- **検証項目**: `min(70,000, 一般＋介護医療＋個人年金)` が適用されること

**テストケース TC-ENGINE-019-2**: 地震保険料控除（住民税は上限2.5万円）
- **前提条件**: 地震保険料支払6万円
- **入力**: `earthquake=60,000`
- **期待結果**: 住民税控除 = 25,000円
- **検証項目**: `min(25,000, 支払額)` が適用されること

**テストケース TC-ENGINE-020**: 医療費控除の計算
- **前提条件**: 治療費4万円、通院交通費1万円、補填0円、総所得500万円、閾値5万円、上限200万円
- **入力**: `treatment = 40,000`, `transport = 10,000`, `reimbursed = 0`, `totalIncomeGeneral = 5,000,000`
- **期待結果**: 実質支払 = 50,000円、閾値 = 50,000円、控除額 = 0円
- **検証項目**: `medDed = clamp(netPaid - medThreshold, 0, cap)`

**テストケース TC-ENGINE-021**: 医療費控除の閾値計算
- **前提条件**: 総所得500万円、閾値固定10万円、閾値率0.05
- **入力**: `totalIncomeGeneral = 5,000,000`, `threshold_fixed = 100,000`, `threshold_rate = 0.05`
- **期待結果**: 閾値 = 100,000円（`min(100,000, floor(5,000,000 * 0.05))`）
- **検証項目**: 固定値と所得割合の小さい方

#### 2.1.6 課税所得計算

**テストケース TC-ENGINE-022**: 課税所得の計算
- **前提条件**: 総所得679万円、所得控除合計200万円
- **入力**: `totalIncomeGeneral = 6,790,000`, `deductionTotal = 2,000,000`
- **期待結果**: 課税所得 = 4,790,000円
- **検証項目**: `taxableIncome = max(0, totalIncomeGeneral - deductionTotal)`

**テストケース TC-ENGINE-023**: 課税所得が0になる場合
- **前提条件**: 総所得200万円、所得控除合計250万円
- **入力**: `totalIncomeGeneral = 2,000,000`, `deductionTotal = 2,500,000`
- **期待結果**: 課税所得 = 0円
- **検証項目**: 負の値にならないこと

#### 2.1.7 所得税計算

**テストケース TC-ENGINE-024**: 所得税の計算（速算表）
- **前提条件**: 2024年度ルール、課税所得479万円
- **入力**: `taxableIncome = 4,790,000`
- **期待結果**: 税率20%、控除額427,500円、所得税 = 530,500円
- **検証項目**: `incomeTax = floor(taxableIncome * rate - deduction)`

**テストケース TC-ENGINE-025**: 所得税率の上書き
- **前提条件**: 課税所得479万円、上書き税率0.25
- **入力**: `taxableIncome = 4,790,000`, `incomeTaxRateOverride = 0.25`
- **期待結果**: 所得税 = 1,197,500円（上書き税率適用）
- **検証項目**: 上書き値が優先されること

#### 2.1.8 住民税計算

**テストケース TC-ENGINE-026**: 住民税 課税所得金額（控除の差異を反映）
- **前提条件**: 住民税の課税所得金額は「所得額 - 住民税用の所得控除額」、1000円未満切り捨て
- **入力**: `residentIncomeAmount`, `residentBasicDeduction`, `socialInsuranceDeduction`, `lifeTotalResidentTax`, `earthquakeResidentTax` 等を与える
- **期待結果**: `floor(max(0, 所得額 - 所得控除合計)/1000)*1000`
- **検証項目**: 生命保険料控除・地震保険料控除が **住民税控除額**で差し引かれること（所得税控除額ではない）

**テストケース TC-ENGINE-027**: 住民税（所得割）
- **前提条件**: 課税所得金額479万円、所得割率10%
- **入力**: `residentTaxableIncome = 4,790,000`, `income_rate = 0.1`
- **期待結果**: 所得割 = 479,000円
- **検証項目**: `residentIncomePart = floor(residentTaxableIncome * income_rate)`

**テストケース TC-ENGINE-027-2**: 住民税（合計）は分離課税の住民税を含む
- **前提条件**: 均等割=5,000円、分離課税ベース=200,000円（住民税5%）
- **入力**: `residentIncomePart=479,000`, `residentPerCapita=5,000`, `stockSeparateBase=200,000`
- **期待結果**: 分離課税の住民税=10,000円、住民税合計=494,000円
- **検証項目**: `residentTotal = residentIncomePart + 5,000 + floor(stockSeparateBase*0.05)`

#### 2.1.9 分離課税計算

**テストケース TC-ENGINE-028**: 株式分離課税の計算
- **前提条件**: 分離課税ベース20万円、税率20.315%
- **入力**: `stockSeparateBase = 200,000`, `rate = 0.20315`
- **期待結果**: 分離課税 = 40,630円
- **検証項目**: `separateTax = floor(stockSeparateBase * rate)`

#### 2.1.10 ふるさと納税計算

**テストケース TC-ENGINE-029**: ふるさと納税 控除対象額の計算
- **前提条件**: 住民税所得割47.9万円、所得税率20%
- **入力**: `residentIncomePart = 479,000`, `incomeTaxRate = 0.2`, `residentRate = 0.1`
- **期待結果**: 特例分上限 = 95,800円、控除対象額 = 136,857円
- **検証項目**: `deductibleLimit = floor((residentIncomePart * 0.2) / (1 - 0.2 - 0.1))`

**テストケース TC-ENGINE-030**: ふるさと納税 寄付額上限の計算
- **前提条件**: 控除対象額136,857円
- **入力**: `deductibleLimit = 136,857`
- **期待結果**: 寄付額上限 = 138,857円
- **検証項目**: `donationLimit = deductibleLimit + 2000`

**テストケース TC-ENGINE-031**: ふるさと納税 内訳計算
- **前提条件**: 控除対象額136,857円、所得税率20%、住民税所得割率10%
- **入力**: `deductibleLimit = 136,857`, `incomeTaxRate = 0.2`, `residentRate = 0.1`
- **期待結果**: 
  - 所得税控除 = 27,371円
  - 住民税基本分 = 13,686円
  - 住民税特例分 = 95,800円
- **検証項目**: 各内訳が正しく計算され、特例分 ≤ 所得割×20%

**テストケース TC-ENGINE-032**: ふるさと納税 仲介サイト比較
- **前提条件**: 本アプリ上限138,857円、サイトA上限90,000円、サイトB上限110,000円
- **入力**: `donationLimit = 138,857`, `comparisonSites = [{amount: 90,000}, {amount: 110,000}]`
- **期待結果**: 採用値 = 90,000円（最小値）
- **検証項目**: `adoptedLimit = min(donationLimit, minSite)`

### 2.2 バリデーション（`validation.ts`）

#### 2.2.1 前年所得（入力方法）検証

**テストケース TC-VALID-001**: 前年所得の入力方法が未選択の場合はエラー
- **前提条件**: `save.previousYearInputMode = 'none'`
- **入力**: `save.previousYearInputMode='none'`
- **期待結果**: `errors` に `field='save.previousYearInputMode'` が含まれる

**テストケース TC-VALID-002**: 前年所得の入力方法がfromSaveで、保存選択がない場合はエラー
- **前提条件**: `save.previousYearInputMode = 'fromSave'`, `save.selectedSaveId=null`
- **入力**: 上記
- **期待結果**: `errors` に `field='save.selectedSaveId'` が含まれる

#### 2.2.2 国保世帯検証（既存 + 追加観点）

**テストケース TC-VALID-003**: 40〜64歳人数が加入者数を超える場合はエラー
- **入力**: `membersIncludingTaxpayer=1`, `members4064=2`
- **期待結果**: `errors` に `field='insurance.nhiHousehold.members4064'` が含まれる

#### 2.2.3 扶養内訳の警告

**テストケース TC-VALID-004**: 扶養人数より内訳人数が多い場合は警告
- **入力**: `dependentCount=0`, `dependents4064Count=1`, `preschoolCount=0`
- **期待結果**: `warnings` に `field='family.dependentCount'` が含まれる

#### 2.2.1 年度検証

**テストケース TC-VALID-001**: 有効な年度
- **入力**: `year = 2024`
- **期待結果**: エラーなし
- **検証項目**: `errors.length === 0`

**テストケース TC-VALID-002**: 無効な年度
- **入力**: `year = 2023`
- **期待結果**: エラー「年度は 2024/2025/2026/2027 のいずれかを指定してください。」
- **検証項目**: エラーメッセージが正しいこと

#### 2.2.2 給与検証

**テストケース TC-VALID-003**: 給与ON時、支払先が0件
- **入力**: `salary.enabled = true`, `salary.sources = []`
- **期待結果**: エラー「給与支払先を1件以上入力してください。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-004**: 給与ON時、主たる支払先が未選択
- **入力**: `salary.enabled = true`, `salary.sources = [{id: 'A', annual: 4000000}]`, `salary.mainSourceId = null`
- **期待結果**: エラー「主たる給与支払先を選択してください。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-005**: 給与年額が負の値
- **入力**: `salary.sources = [{id: 'A', annual: -1000000}]`
- **期待結果**: エラー「給与年額は0以上で入力してください。」
- **検証項目**: エラーメッセージが正しいこと

#### 2.2.3 事業検証

**テストケース TC-VALID-006**: 事業ON時、売上が0以下
- **入力**: `business.enabled = true`, `business.sales = 0`
- **期待結果**: エラー「事業売上を入力してください。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-007**: 経費が負の値
- **入力**: `business.expenses = -100000`
- **期待結果**: エラー「経費は0以上で入力してください。」
- **検証項目**: エラーメッセージが正しいこと

#### 2.2.4 保険検証（複合モード）

**テストケース TC-VALID-008**: 複合ブロックの合計月数が12でない
- **入力**: `insurance.mode = 'mixed'`, `blocks = [{months: 6}, {months: 5}]`
- **期待結果**: エラー「複合ブロックの合計月数は12ヶ月にしてください。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-009**: 社保ブロックのサブ月数合計が親ブロック月数と不一致
- **入力**: `blocks = [{type: 'employee', months: 6, breakdown: [{months: 5}]}]`
- **期待結果**: エラー「社保ブロックのサブ月数合計がブロック月数と一致していません。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-010**: 国保ブロックの国保サブ月数合計が親ブロック月数と不一致
- **入力**: `blocks = [{type: 'national', months: 6, nhiBreakdown: [{months: 5}]}]`
- **期待結果**: エラー「国保ブロックの国保サブ月数合計がブロック月数と一致していません。」
- **検証項目**: エラーメッセージが正しいこと

#### 2.2.5 保険検証（国保のみモード）

**テストケース TC-VALID-011**: 国年加入月数+免除月数が12でない
- **入力**: `insurance.mode = 'nationalOnly'`, `np.payMonths = 5`, `np.exemptMonths = 6`
- **期待結果**: エラー「国民年金の加入月数と免除月数の合計は12ヶ月にしてください。」
- **検証項目**: エラーメッセージが正しいこと

#### 2.2.6 国保世帯検証

**テストケース TC-VALID-012**: 国保加入者数が0
- **入力**: `nhiHousehold.membersIncludingTaxpayer = 0`
- **期待結果**: エラー「国保加入者数は本人を含め1以上にしてください。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-013**: 40-64歳人数が加入者数を超える
- **入力**: `membersIncludingTaxpayer = 3`, `members4064 = 4`
- **期待結果**: エラー「40〜64歳人数が国保加入者数を超えています。」
- **検証項目**: エラーメッセージが正しいこと

**テストケース TC-VALID-014**: 未就学児人数が加入者数を超える
- **入力**: `membersIncludingTaxpayer = 3`, `preschool = 4`
- **期待結果**: エラー「未就学児人数が国保加入者数を超えています。」
- **検証項目**: エラーメッセージが正しいこと

#### 2.2.7 警告

**テストケース TC-VALID-015**: 扶養人数より内訳人数が多い
- **入力**: `dependentCount = 1`, `dependents4064Count = 1`, `preschoolCount = 1`
- **期待結果**: 警告「扶養人数より内訳人数が多くなっています。」
- **検証項目**: 警告メッセージが正しいこと

### 2.3 データ保存（`storage.ts`）

#### 2.3.1 保存名生成

**テストケース TC-STORAGE-001**: 保存名の自動生成
- **前提条件**: 年度2024、既存保存なし
- **入力**: `year = 2024`
- **期待結果**: 保存名 = "2024年度_納税金額試算_YYYYMMDD-001"形式
- **検証項目**: 形式が正しいこと、連番が001から始まること

**テストケース TC-STORAGE-002**: 保存名の連番生成
- **前提条件**: 同じ日付で既に2件保存されている
- **入力**: `year = 2024`
- **期待結果**: 保存名 = "2024年度_納税金額試算_YYYYMMDD-003"
- **検証項目**: 連番が003になること

#### 2.3.2 保存処理

**テストケース TC-STORAGE-003**: 新規保存
- **前提条件**: 保存名が重複していない
- **入力**: 有効な`SaveRecord`データ
- **期待結果**: 保存成功、`localStorage`にデータが保存される
- **検証項目**: `localStorage.getItem('tax-sim:saves:v1')`にデータが存在

**テストケース TC-STORAGE-004**: 保存名重複エラー
- **前提条件**: 同じ保存名が既に存在
- **入力**: 既存と同じ保存名
- **期待結果**: `SAVE_NAME_DUPLICATED`エラー
- **検証項目**: エラーがthrowされること

#### 2.3.3 読み込み処理

**テストケース TC-STORAGE-005**: 保存一覧の読み込み
- **前提条件**: `localStorage`に3件の保存データがある
- **入力**: `loadSaves()`
- **期待結果**: 3件の`SaveRecord`配列、更新日時降順
- **検証項目**: 配列の長さ、ソート順

#### 2.3.4 名前変更処理

**テストケース TC-STORAGE-006**: 保存名の変更
- **前提条件**: 保存データが存在
- **入力**: `id`, `newName = "新しい名前"`
- **期待結果**: 保存名が変更される、`updatedAt`が更新される
- **検証項目**: `localStorage`のデータが更新されること

**テストケース TC-STORAGE-007**: 名前変更時の重複エラー
- **前提条件**: 変更先の名前が既に存在（自分以外）
- **入力**: 既存と同じ名前
- **期待結果**: `SAVE_NAME_DUPLICATED`エラー
- **検証項目**: エラーがthrowされること

#### 2.3.5 削除処理

**テストケース TC-STORAGE-008**: 保存データの削除
- **前提条件**: 保存データが存在
- **入力**: `id`
- **期待結果**: 該当データが削除される
- **検証項目**: `localStorage`からデータが削除されること

### 2.4 ユーティリティ（`format.ts`）

#### 2.4.1 金額フォーマット

**テストケース TC-FORMAT-001**: 正の金額のフォーマット
- **入力**: `n = 1234567`
- **期待結果**: `"￥1,234,567"`
- **検証項目**: カンマ区切り、￥記号

**テストケース TC-FORMAT-002**: 負の金額のフォーマット
- **入力**: `n = -1234567`
- **期待結果**: `"-￥1,234,567"`
- **検証項目**: マイナス記号、カンマ区切り

**テストケース TC-FORMAT-003**: ゼロのフォーマット
- **入力**: `n = 0`
- **期待結果**: `"￥0"`
- **検証項目**: ゼロが正しく表示されること

**テストケース TC-FORMAT-004**: 小数点の切り捨て
- **入力**: `n = 1234.56`
- **期待結果**: `"￥1,234"`
- **検証項目**: 小数点以下が切り捨てられること

## 3. 結合テスト仕様

### 3.1 計算エンジンとルール読み込み

**テストケース TC-INTEG-001**: 年度別ルールの適用
- **前提条件**: 2024年度と2025年度で基礎控除が異なる
- **入力**: 同じ入力データ、年度のみ変更
- **期待結果**: 年度に応じた基礎控除が適用される
- **検証項目**: 2024年度と2025年度で結果が異なること

**テストケース TC-INTEG-002**: ルールの継承
- **前提条件**: 2025年度ルールが2024年度を継承
- **入力**: 2025年度の入力データ
- **期待結果**: 継承されたルールが適用される
- **検証項目**: 継承元のルールが正しく適用されること

### 3.2 計算エンジンとバリデーション

**テストケース TC-INTEG-003**: バリデーション通過後の計算実行
- **前提条件**: 入力データが有効
- **入力**: 有効な`TaxInput`
- **期待結果**: 計算が正常に実行される
- **検証項目**: `EngineOutput`が返されること

**テストケース TC-INTEG-004**: バリデーションエラー時の計算ブロック
- **前提条件**: 入力データにエラーがある
- **入力**: 無効な`TaxInput`
- **期待結果**: 計算が実行されない
- **検証項目**: エラーメッセージが表示されること

### 3.3 データ保存と計算結果

**テストケース TC-INTEG-005**: 計算結果の保存
- **前提条件**: 計算が正常に完了
- **入力**: `EngineOutput`、`TaxInput`
- **期待結果**: 保存成功、`previousYearTotalIncome`が設定される
- **検証項目**: `SaveRecord`に`derived.totalIncomeGeneral`が設定されること

**テストケース TC-INTEG-006**: 保存データの読み込みと計算
- **前提条件**: 保存データが存在
- **入力**: 保存データの`input`
- **期待結果**: 読み込んだデータで計算が正常に実行される
- **検証項目**: 計算結果が保存時と同じこと

## 4. システムテスト仕様

## 5. UIテスト（手動/将来のE2E想定）

### 5.1 数値入力（0入力）

**テストケース TC-UI-001**: `type="number"` の入力で 0 を入力できる
- **手順**: 任意の数値入力に `0` を入力してフォーカスアウト
- **期待結果**: 入力欄に `0` が残り、空扱いにならない（内部値も0）

### 5.2 必須未入力時のスクロール（固定ヘッダー考慮）

**テストケース TC-UI-002**: 必須項目未入力で「入力内容で計算する」を押下すると、先頭エラーへスクロール
- **前提**: 必須項目（例: 納税者年齢、前年所得の入力方法など）を未入力にする
- **手順**: 「入力内容で計算する」を押下
- **期待結果**:
  - 先頭の必須未入力フィールドへスクロールされる
  - スクロール位置は固定ヘッダー高さ分だけ上に余白が確保される
  - 対象入力にフォーカスされる

### 5.3 結果を保存ボタン（表示・活性制御）

**テストケース TC-UI-003**: 「結果を保存」ボタンは常に表示される
- **手順**: 初期表示のヘッダーを確認
- **期待結果**: ヘッダーのボタン行に「結果を保存」ボタンが存在する

**テストケース TC-UI-004**: 計算前は「結果を保存」が無効、計算後に有効化される
- **手順**:
  1. 初期状態で「結果を保存」を確認
  2. 「入力内容で計算する」を押下し、結果が生成された状態にする
- **期待結果**:
  - 計算前: 「結果を保存」は disabled
  - 計算後: 「結果を保存」は enabled

### 4.1 エンドツーエンドテスト

**テストケース TC-SYSTEM-001**: 完全な計算フロー
- **前提条件**: デモ入力データ
- **手順**:
  1. アプリ起動
  2. デモ入力データを適用
  3. 計算ボタンをクリック
  4. 結果を確認
- **期待結果**: すべての計算が正常に実行され、結果が表示される
- **検証項目**: サマリー（所得税（合計）、住民税（合計）、社会保険料控除、ふるさと納税上限を含む。株式（分離）は表示しない）、CalcLine、ふるさと納税上限が表示されること

**テストケース TC-SYSTEM-002**: 保存・読み込みフロー
- **前提条件**: 計算結果が表示されている
- **手順**:
  1. 計算を実行
  2. 保存ボタンをクリック
  3. 保存一覧から選択
  4. 読み込んだデータで再計算
- **期待結果**: 保存・読み込みが正常に動作し、同じ結果が得られる
- **検証項目**: 保存データが正しく復元されること

**テストケース TC-SYSTEM-003**: 前年所得の利用
- **前提条件**: 2024年度の保存データが存在
- **手順**:
  1. 2025年度を選択
  2. 前年所得として2024年度の保存データを選択
  3. 国保推計を実行
- **期待結果**: 前年総所得が国保推計に使用される
- **検証項目**: 国保推計に前年所得が反映されること

### 4.2 UI操作テスト

**テストケース TC-SYSTEM-004**: アコーディオンの開閉
- **手順**:
  1. 各セクションのsummaryをクリック
  2. 開閉状態を確認
- **期待結果**: 各セクションが正しく開閉される
- **検証項目**: `openSection`状態が正しく更新されること

**テストケース TC-SYSTEM-005**: 入力フィールドの操作
- **手順**:
  1. 各入力フィールドに値を入力
  2. 値が正しく反映されることを確認
- **期待結果**: 入力値が正しく保持される
- **検証項目**: `TaxInput`状態が正しく更新されること

**テストケース TC-SYSTEM-006**: エラーメッセージの表示
- **前提条件**: 無効な入力データ
- **手順**:
  1. 無効な値を入力
  2. 計算ボタンをクリック
- **期待結果**: エラーメッセージが表示される
- **検証項目**: エラーメッセージが正しく表示されること

## 5. テストデータ

### 5.1 標準テストデータ

#### テストデータ TD-001: 基本ケース
```json
{
  "year": 2024,
  "family": {
    "taxpayerAge": 42,
    "spouseCount": 0,
    "dependentCount": 1,
    "dependents4064Count": 0,
    "preschoolCount": 0
  },
  "salary": {
    "enabled": true,
    "sources": [
      { "id": "A", "name": "支払先A", "annual": 4000000 },
      { "id": "B", "name": "支払先B", "annual": 1200000 }
    ],
    "mainSourceId": "A"
  },
  "business": {
    "enabled": true,
    "sales": 5000000,
    "expenses": 1200000,
    "blueReturn": {
      "enabled": true,
      "mode": "electronic"
    }
  },
  "stocks": {
    "dividend": { "amount": 80000, "taxMode": "general" },
    "capitalGain": { "amount": 200000, "taxMode": "separate" }
  },
  "deductions": {
    "ideco": 120000,
    "smallBizMutualAid": 240000,
    "safetyMutualAid": 200000,
    "lifeInsurance": {
      "general": 80000,
      "nursingMedical": 50000,
      "pension": 60000
    },
    "earthquake": 30000,
    "medical": {
      "enabled": true,
      "treatment": 40000,
      "transport": 10000,
      "other": 0,
      "reimbursed": 0
    }
  },
  "insurance": {
    "mode": "mixed",
    "employee": null,
    "national": null,
    "mixed": {
      "blocks": [
        {
          "id": "emp1",
          "type": "employee",
          "months": 6,
          "breakdown": [
            {
              "id": "emp1a",
              "mode": "estimate",
              "months": 6,
              "baseSalarySourceId": "A"
            }
          ]
        },
        {
          "id": "nat1",
          "type": "national",
          "months": 6,
          "nhiBreakdown": [
            {
              "id": "nat1a",
              "mode": "estimate",
              "months": 6,
            }
          ],
          "npPayMonths": 5,
          "npExemptMonths": 1,
          "npMonthlyOverride": null
        }
      ]
    },
    "nhiHousehold": {
      "membersIncludingTaxpayer": 3,
      "members4064": 1,
      "preschool": 0
    }
  },
  "overrides": {
    "incomeTaxRateOverride": null,
    "residentIncomeRateOverride": null,
    "separateTaxRateOverride": null
  },
  "comparisonSites": [
    { "id": "siteA", "name": "サイトA", "amount": 90000 },
    { "id": "siteB", "name": "サイトB", "amount": 110000 }
  ],
  "save": {
    "selectedSaveId": null,
    "previousYearTotalIncome": null
  }
}
```

#### テストデータ TD-002: エラーケース（給与支払先なし）
```json
{
  "year": 2024,
  "salary": {
    "enabled": true,
    "sources": [],
    "mainSourceId": null
  }
}
```

#### テストデータ TD-003: エラーケース（複合ブロック月数不一致）
```json
{
  "insurance": {
    "mode": "mixed",
    "mixed": {
      "blocks": [
        { "type": "employee", "months": 6 },
        { "type": "national", "months": 5 }
      ]
    }
  }
}
```

### 5.2 境界値テストデータ

#### テストデータ TD-004: 最低給与収入
- 給与収入: 550,000円（給与所得控除の最低保障）

#### テストデータ TD-005: 最高給与収入
- 給与収入: 10,000,000円（給与所得控除の上限）

#### テストデータ TD-006: 基礎控除の境界値
- 総所得: 24,000,000円（基礎控除480,000円）
- 総所得: 24,500,000円（基礎控除320,000円）
- 総所得: 25,000,000円（基礎控除160,000円）
- 総所得: 25,000,001円（基礎控除0円）

## 6. テスト実行手順

### 6.1 単体テストの実行

```bash
# Vitestのインストール（初回のみ）
npm install -D vitest @vitest/ui

# 単体テストの実行
npm run test

# カバレッジ付きで実行
npm run test:coverage

# ウォッチモードで実行
npm run test:watch
```

### 6.2 結合テストの実行

```bash
# 結合テストの実行
npm run test:integration
```

### 6.3 システムテストの実行

```bash
# 開発サーバー起動
npm run dev

# ブラウザで手動テスト実施
# または Playwright で自動テスト（将来実装）
npm run test:e2e
```

## 7. テストカバレッジ目標

### 7.1 カバレッジ目標値

- **行カバレッジ**: 80%以上
- **分岐カバレッジ**: 75%以上
- **関数カバレッジ**: 85%以上

### 7.2 優先度別カバレッジ

- **高優先度**: 計算エンジン（`engine.ts`）→ 90%以上
- **中優先度**: バリデーション（`validation.ts`）→ 85%以上
- **低優先度**: UI（`App.tsx`）→ 70%以上

## 7.3 境界値テスト（追加）

### 7.3.1 生命保険料控除（カテゴリ別の閾値）

- **TC-ENGINE-BND-LIFE-001**: 所得税（2万円ちょうど）→ 控除=20,000円
- **TC-ENGINE-BND-LIFE-002**: 所得税（2万円超、例: 20,001円）→ 控除=floor(支払/2+10,000)
- **TC-ENGINE-BND-LIFE-003**: 所得税（4万円ちょうど）→ 控除=floor(40,000/2+10,000)=30,000円
- **TC-ENGINE-BND-LIFE-004**: 所得税（8万円ちょうど）→ 控除=floor(80,000/4+20,000)=40,000円
- **TC-ENGINE-BND-LIFE-005**: 住民税（8万円超、例: 80,001円）→ 控除=28,000円（カテゴリ上限）

### 7.3.2 国保推計（上限適用）

- **TC-ENGINE-BND-NHI-001**: 基礎（医療）分が上限66万円に張り付くケース（前年所得が十分大）
- **TC-ENGINE-BND-NHI-002**: 支援金分が上限26万円に張り付くケース
- **TC-ENGINE-BND-NHI-003**: 介護分が上限17万円に張り付くケース

### 7.3.3 住民税（1000円未満切り捨て）

- **TC-ENGINE-BND-RES-001**: 課税所得金額=999円 → 0円
- **TC-ENGINE-BND-RES-002**: 課税所得金額=1000円 → 1000円

### 7.3.4 バリデーション（必須選択/合計月数）

- **TC-VALID-BND-001**: `save.previousYearInputMode='none'` → エラー
- **TC-VALID-BND-002**: `fromSave`かつ`selectedSaveId=null` → エラー
- **TC-VALID-BND-003**: 複合ブロック合計月数=11/13 → エラー
- **TC-VALID-BND-004**: 国年 pay+exempt=11/13 → エラー

## 8. バグ管理

### 8.1 バグの分類

- **Critical**: 計算結果が間違っている、アプリがクラッシュする
- **High**: 重要な機能が動作しない、データが保存できない
- **Medium**: 一部機能が動作しない、UI表示の問題
- **Low**: 軽微なUIの問題、改善提案

### 8.2 バグレポート形式

```
【バグID】: BUG-001
【重要度】: Critical
【発生箇所】: engine.ts / calculateAll
【再現手順】:
1. テストデータTD-001を入力
2. 計算ボタンをクリック
【期待結果】: （例）所得税 = 530,500円
【実際の結果】: （例）所得税 = 0円
【環境】: Chrome 120, Windows 11
```

## 9. テストスケジュール

### 9.1 テストフェーズ

1. **単体テスト**: 開発と並行して実施
2. **結合テスト**: 各モジュール完成後に実施
3. **システムテスト**: 全機能実装後に実施
4. **回帰テスト**: バグ修正後に実施

### 9.2 テスト実施タイミング

- **開発中**: 単体テストを継続的に実施
- **機能完成時**: 結合テストを実施
- **リリース前**: システムテストを実施
- **バグ修正後**: 該当機能の回帰テストを実施

## 10. テスト環境のセットアップ

### 10.1 必要なツール

- Node.js 18以上
- npm または yarn
- Vitest
- Playwright（将来実装）

### 10.2 セットアップ手順

```bash
# プロジェクトのクローン
git clone <repository-url>
cd tax_simulator

# 依存関係のインストール
npm install

# テスト用の依存関係のインストール
npm install -D vitest @vitest/ui @testing-library/react @testing-library/jest-dom

# テストの実行
npm run test
```

## 11. テストメンテナンス

### 11.1 テストの更新

- 機能追加時: 新しいテストケースを追加
- 仕様変更時: 既存のテストケースを更新
- バグ発見時: 再現テストケースを追加

### 11.2 テストのリファクタリング

- 重複するテストコードの共通化
- テストデータの外部化
- テストヘルパー関数の作成

## 12. 参考資料

- 要件定義書: `design/REQUIREMENTS.md`
- 基本設計書: `design/BASIC_DESIGN.md`
- 詳細設計書: `design/DETAILED_DESIGN.md`
- UIデザイン仕様書: `design/UI_DESIGN.md`

