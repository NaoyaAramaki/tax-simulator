# 納税金額シミュレーター 要件定義書

## 1. プロジェクト概要

### 1.1 システム名
納税金額シミュレーター

### 1.2 目的
本システムは、所得税・住民税・株式分離課税・ふるさと納税の上限額を計算するためのローカル実行型のシミュレーターです。計算式の透明性を重視し、すべての計算過程を表示することで、ユーザーが計算結果を理解・検証できることを目的とします。

### 1.3 対象ユーザー
- 個人事業主
- 給与所得者
- 株式投資家
- ふるさと納税を検討している納税者

### 1.4 適用範囲
- 2024年度、2025年度、2026年度、2027年度の税制に対応
- 東京都世田谷区を基準とした住民税計算（標準的な税率・均等割）
- ローカル実行（ブラウザ上で動作、外部API不要）

## 2. 機能要件

### 2.1 収入入力機能

#### 2.1.1 給与収入
- **FR-001**: 給与収入のON/OFF切り替えが可能
- **FR-002**: 複数の給与支払先を登録可能（複数社からの給与に対応）
- **FR-003**: 主たる給与支払先を選択可能
- **FR-004**: 各支払先ごとに年額を入力可能

#### 2.1.2 事業所得
- **FR-005**: 事業所得のON/OFF切り替えが可能
- **FR-006**: 売上金額を入力可能
- **FR-007**: 経費金額を入力可能
- **FR-008**: 青色申告の有無を選択可能
- **FR-009**: 青色申告方式（電子帳簿/帳簿方式）を選択可能
- **FR-010**: 青色申告控除額は方式に応じて自動適用（電子帳簿=65万円、帳簿方式=55万円）

#### 2.1.3 株式収入
- **FR-011**: 配当収入の金額を入力可能
- **FR-012**: 配当収入の課税方式（総合課税/分離課税）を選択可能
- **FR-013**: 株式譲渡益の金額を入力可能
- **FR-014**: 株式譲渡益の課税方式（総合課税/分離課税）を選択可能

### 2.2 控除入力機能

#### 2.2.1 社会保険料控除
- **FR-015**: 社会保険料（社保）の入力モードを選択可能（手入力/推計）
- **FR-016**: 国民健康保険料（国保）の入力モードを選択可能（手入力/推計）
- **FR-017**: 国民年金（国年）の加入月数・免除月数を入力可能
- **FR-018**: 保険モードを選択可能（社保のみ/国保のみ/複合）
- **FR-019**: 複合モードで、年度内の保険切り替えをブロック単位で入力可能
- **FR-020**: 国保世帯情報（加入者数、40-64歳人数、未就学児人数）を入力可能
- **FR-021**: 前年総所得を利用した国保推計が可能

#### 2.2.2 その他控除
- **FR-022**: iDeCo掛金を入力可能
- **FR-023**: 小規模企業共済掛金を入力可能
- **FR-024**: 経営セーフティ共済掛金を入力可能
- **FR-025**: 生命保険料控除（一般/介護医療/個人年金）を入力可能
- **FR-026**: 地震保険料を入力可能
- **FR-027**: 医療費控除のON/OFF切り替えが可能
- **FR-028**: 医療費控除の内訳（治療費/通院交通費/その他）を入力可能
- **FR-029**: 医療費控除の補填額を入力可能

### 2.3 家族情報入力機能
- **FR-030**: 納税者年齢を入力可能
- **FR-031**: 配偶者数を入力可能（任意入力）
- **FR-032**: 扶養人数を入力可能（任意入力）
- **FR-033**: 扶養内の40-64歳人数を入力可能
- **FR-034**: 扶養内の未就学児人数を入力可能

### 2.4 計算機能

#### 2.4.1 税額計算
- **FR-035**: 所得税（合計）= 所得税（総合課税）+ 分離課税の所得税 + 復興特別所得税を計算可能
- **FR-036**: 住民税（所得割+均等割）を計算可能
- **FR-037**: 株式分離課税を計算可能
- **FR-038**: ふるさと納税の寄付額上限を計算可能（正式公式②）
- **FR-039**: ふるさと納税の控除内訳（所得税/住民税基本分/住民税特例分）を計算可能

#### 2.4.2 計算過程表示
- **FR-040**: すべての計算過程を`CalcLine`として表示可能
- **FR-041**: 計算過程をセクション別に折りたたみ表示可能
- **FR-042**: 計算式と計算項を表示可能
- **FR-043**: 計算結果の注記・警告を表示可能

#### 2.4.3 比較機能
- **FR-044**: 複数の仲介サイトのふるさと納税上限額を入力可能
- **FR-045**: 本アプリと仲介サイトの上限額を比較表示可能
- **FR-046**: 比較結果として、より低い上限額を採用可能

### 2.5 保存・読み込み機能
- **FR-047**: 計算結果を保存可能（入力データ、計算結果、前年総所得を含む）
- **FR-048**: 保存名を自動生成可能（形式: `YYYY年度_納税金額試算_YYYYMMDD-連番`）
- **FR-049**: 保存名を手動で指定可能
- **FR-050**: 保存名の重複を検出可能
- **FR-051**: 保存一覧を表示可能（更新日時降順）
- **FR-052**: 保存データを読み込んで入力データを復元可能
- **FR-053**: 保存名を変更可能
- **FR-054**: 保存データを削除可能
- **FR-055**: 保存データの前年総所得を次年度の国保推計に利用可能
- **FR-055-1**: 前年所得の入力方法（保存データ/今年の情報を仮使用/手入力）は必須選択とする（未選択は不可）

### 2.6 年度管理機能
- **FR-056**: 計算対象年度を選択可能（2024/2025/2026/2027）
- **FR-057**: 年度に応じた税制ルールを自動適用可能

### 2.7 係数上書き機能
- **FR-058**: 所得税率を手動で上書き可能
- **FR-059**: 住民税所得割率を手動で上書き可能
- **FR-060**: 分離課税税率を手動で上書き可能

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **NFR-001**: 計算処理は1秒以内に完了すること
- **NFR-002**: UI操作の応答性を維持すること（入力変更時の即時反映）

### 3.2 可用性要件
- **NFR-003**: ブラウザの`localStorage`が利用可能な環境で動作すること
- **NFR-004**: 外部APIに依存しないローカル実行型であること

### 3.3 保守性要件
- **NFR-005**: 年度別の税制ルールをJSONファイルで管理可能であること
- **NFR-006**: ルールファイルの継承機能により、変更点のみを定義可能であること
- **NFR-007**: 型安全性を確保するためTypeScriptを使用すること

### 3.4 ユーザビリティ要件
- **NFR-008**: 計算式の透明性を確保し、すべての計算過程を表示すること
- **NFR-009**: 入力エラーを明確に表示すること
- **NFR-010**: 入力警告を適切に表示すること
- **NFR-011**: アコーディオン形式のUIで、セクションを折りたたみ可能であること
- **NFR-014**: 必須項目が未入力で「入力内容で計算」を押下した場合、未入力箇所の先頭へ自動スクロールしフォーカスする（固定ヘッダー高さを考慮）
- **NFR-015**: 数値入力（number）で 0 を正しく入力できること（0 が空扱いにならないこと）

### 3.5 互換性要件
- **NFR-012**: モダンブラウザ（Chrome、Firefox、Safari、Edgeの最新版）で動作すること
- **NFR-013**: `localStorage`が利用可能なブラウザで動作すること

## 4. 制約事項

### 4.1 技術的制約
- **CON-001**: ブラウザ上で実行されるクライアントサイドアプリケーションであること
- **CON-002**: 外部APIやサーバーサイド処理を使用しないこと
- **CON-003**: データ保存は`localStorage`のみを使用すること（ブラウザ削除で消失の可能性あり）

### 4.2 法的制約
- **CON-004**: 本システムは概算・比較用途であり、最終的な控除額は自治体・税務署の確定処理に依存すること
- **CON-005**: 計算結果の正確性について保証しないこと

### 4.3 機能制約
- **CON-006**: 国保の法定軽減（7割/5割/2割）は未実装（想定差分のみ表示）
- **CON-007**: 住民税は東京都世田谷区を基準とした標準的な計算（自治体ごとの細かい差異は考慮しない）
- **CON-008**: 配偶者控除、扶養控除などの詳細な控除計算は簡略化

## 5. システム境界

### 5.1 対象外機能
- 確定申告書の自動生成
- 税務署への電子申告（e-Tax等）
- 複数年度の比較分析
- グラフ・チャート表示
- データのエクスポート/インポート（CSV、Excel等）
- ユーザー認証・アカウント管理
- クラウド同期

### 5.2 外部システム連携
- 外部システムとの連携はなし
- 税務署システムとの連携はなし

## 6. 用語定義

| 用語 | 説明 |
|------|------|
| 総合課税 | 他の所得と合算して税額を計算する課税方式 |
| 分離課税 | 他の所得と分離して税額を計算する課税方式 |
| 給与所得控除 | 給与収入から一定額を控除して給与所得を算出する制度 |
| 基礎控除 | すべての納税者に適用される控除 |
| 社会保険料控除 | 社会保険料の支払額をそのまま控除する制度 |
| ふるさと納税 | 地方自治体への寄付により税額控除が受けられる制度 |
| 控除対象額 | ふるさと納税で控除される金額（寄付額-2,000円） |
| 住民税特例分 | ふるさと納税の控除のうち、住民税の特例分（住民税（合計）×20%が上限） |
| 按分計算 | 年額を月数に応じて分割計算すること |
| CalcLine | 計算過程を表現するデータ構造 |

## 7. 前提条件

### 7.1 ユーザー前提
- 基本的な税務知識を有していること
- ブラウザの基本的な操作が可能であること

### 7.2 システム前提
- モダンブラウザがインストールされていること
- JavaScriptが有効であること
- `localStorage`が利用可能であること

## 8. 注意事項

### 8.1 使用上の注意
1. **概算・比較用途**: 本システムは概算・比較用途です。最終的な控除額は自治体・税務署の確定処理に依存します。
2. **ふるさと納税**: ふるさと納税の上限額は、本ツールと仲介サイトの「低い方」を採用してください。
3. **国保法定軽減**: 国保の法定軽減（7割/5割/2割）は未実装です。結果画面に「想定差分」として概算を表示します。
4. **保存データ**: データは`localStorage`に保存されます。ブラウザのデータを削除すると消失する可能性があります。

### 8.2 免責事項
- 本システムの計算結果の正確性について保証しません。
- 本システムの使用により生じた損害について、一切の責任を負いません。
- 税務に関する最終的な判断は、税理士や税務署にご相談ください。

## 9. 今後の拡張予定

### 9.1 機能拡張
- Vitestテストの実装
- 国保法定軽減の実装
- バリデーション警告の拡充
- UI/UXの改善
- データのエクスポート/インポート機能
- 複数年度の比較分析機能

### 9.2 技術的改善
- パフォーマンス最適化
- アクセシビリティ対応
- レスポンシブデザイン対応

